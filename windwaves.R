#' Surface winds
#' Greater Australian Region
#' 
#' 



# system(sprintf("gdalinfo %s", tfiles[1]))
# Driver: PNG/Portable Network Graphics
# Files: dev/www.bom.gov.au/charts_data/IDY20300/current/windarrow/10m/IDY20300.windarrow-10m.000.png
# Size is 751, 527
# Coordinate System is `'
# Corner Coordinates:
# Upper Left  (    0.0,    0.0)
# Lower Left  (    0.0,  527.0)
# Upper Right (  751.0,    0.0)
# Lower Right (  751.0,  527.0)
# Center      (  375.5,  263.5)
# Band 1 Block=751x1 Type=Byte, ColorInterp=Palette
# Color Table (RGB with 256 entries)

tx <- unlist(strsplit("0: 0,0,0,255
1: 5,5,5,255
2: 10,12,9,255
3: 11,15,17,255
4: 12,17,12,255
5: 14,16,17,255
6: 20,22,19,255
7: 18,11,6,255
8: 21,30,34,255
9: 24,36,23,255
10: 28,32,34,255
11: 46,19,7,255
12: 48,45,23,255
13: 36,36,36,255
14: 32,44,51,255
15: 35,54,34,255
16: 41,48,51,255
17: 61,62,33,255
18: 52,52,52,255
19: 58,41,39,255
20: 33,31,32,255
21: 42,59,68,255
22: 52,63,68,255
23: 45,69,44,255
24: 56,86,54,255
25: 49,68,52,255
26: 59,104,56,255
27: 55,64,68,255
28: 59,67,69,255
29: 53,74,83,255
30: 63,88,101,255
31: 80,20,9,255
32: 81,48,10,255
33: 78,52,43,255
34: 107,23,8,255
35: 111,42,21,255
36: 117,54,42,255
37: 86,68,16,255
38: 83,82,46,255
39: 103,82,20,255
40: 115,79,45,255
41: 115,109,54,255
42: 91,103,47,255
43: 69,69,70,255
44: 69,81,85,255
45: 87,87,88,255
46: 82,82,76,255
47: 73,92,101,255
48: 69,103,68,255
49: 81,119,78,255
50: 94,112,72,255
51: 81,115,81,255
52: 82,97,102,255
53: 76,104,118,255
54: 119,78,76,255
55: 109,110,75,255
56: 101,102,103,255
57: 97,112,119,255
58: 108,116,118,255
59: 119,119,119,255
60: 112,116,119,255
61: 121,117,122,255
62: 122,101,102,255
63: 104,94,99,255
64: 84,117,135,255
65: 103,124,136,255
66: 125,130,42,255
67: 87,138,84,255
68: 93,163,88,255
69: 104,152,102,255
70: 101,178,96,255
71: 115,170,112,255
72: 127,187,123,255
73: 115,173,102,255
74: 112,148,84,255
75: 126,222,120,255
76: 119,208,112,255
77: 110,193,104,255
78: 94,132,152,255
79: 109,128,136,255
80: 123,144,153,255
81: 116,140,144,255
82: 105,146,168,255
83: 115,161,185,255
84: 120,168,171,255
85: 121,164,135,255
86: 125,176,202,255
87: 153,0,0,255
88: 145,25,8,255
89: 131,62,49,255
90: 173,33,11,255
91: 138,75,49,255
92: 141,116,53,255
93: 188,74,8,255
94: 182,89,53,255
95: 154,104,31,255
96: 135,77,68,255
97: 149,94,85,255
98: 138,90,83,255
99: 140,111,77,255
100: 129,111,118,255
101: 150,107,102,255
102: 147,118,116,255
103: 181,68,68,255
104: 167,125,119,255
105: 165,120,114,255
106: 164,114,103,255
107: 178,114,76,255
108: 229,39,12,255
109: 231,52,25,255
110: 218,45,20,255
111: 201,112,35,255
112: 203,100,59,255
113: 237,87,53,255
114: 220,110,66,255
115: 255,125,75,255
116: 252,122,77,255
117: 252,116,71,255
118: 240,105,72,255
119: 239,93,66,255
120: 132,125,135,255
121: 140,157,56,255
122: 145,148,57,255
123: 174,141,56,255
124: 189,161,55,255
125: 170,129,26,255
126: 143,139,79,255
127: 155,156,118,255
128: 148,145,110,255
129: 140,180,84,255
130: 148,174,109,255
131: 171,149,87,255
132: 168,149,110,255
133: 162,173,78,255
134: 164,164,79,255
135: 172,173,89,255
136: 177,166,119,255
137: 188,167,115,255
138: 177,164,112,255
139: 135,222,120,255
140: 151,207,119,255
141: 153,225,123,255
142: 167,214,123,255
143: 170,212,126,255
144: 177,209,120,255
145: 161,226,126,255
146: 193,136,46,255
147: 194,170,119,255
148: 204,182,102,255
149: 253,137,88,255
150: 252,155,105,255
151: 246,182,117,255
152: 251,166,117,255
153: 216,150,103,255
154: 209,209,107,255
155: 232,219,115,255
156: 238,202,113,255
157: 230,230,117,255
158: 229,232,124,255
159: 148,148,149,255
160: 141,137,140,255
161: 139,153,168,255
162: 138,179,145,255
163: 136,161,169,255
164: 150,176,187,255
165: 156,188,185,255
166: 144,168,182,255
167: 174,149,148,255
168: 170,171,146,255
169: 167,166,168,255
170: 182,184,187,255
171: 172,182,179,255
172: 168,159,163,255
173: 136,190,219,255
174: 147,181,203,255
175: 169,188,203,255
176: 138,204,134,255
177: 150,221,145,255
178: 152,209,140,255
179: 136,226,131,255
180: 146,229,140,255
181: 155,234,150,255
182: 158,241,152,255
183: 191,203,187,255
184: 182,197,182,255
185: 168,202,174,255
186: 161,238,156,255
187: 162,229,152,255
188: 162,244,157,255
189: 165,246,157,255
190: 178,229,134,255
191: 172,255,167,255
192: 169,252,164,255
193: 167,247,162,255
194: 176,254,173,255
195: 177,247,173,255
196: 181,250,188,255
197: 181,253,182,255
198: 167,237,166,255
199: 163,205,156,255
200: 150,195,218,255
201: 147,205,236,255
202: 157,222,245,255
203: 156,219,252,255
204: 154,209,233,255
205: 159,226,235,255
206: 164,192,204,255
207: 182,209,221,255
208: 180,198,208,255
209: 163,222,253,255
210: 177,217,238,255
211: 173,237,219,255
212: 175,240,212,255
213: 183,247,200,255
214: 181,243,209,255
215: 177,236,213,255
216: 166,230,231,255
217: 170,225,253,255
218: 191,224,238,255
219: 181,236,230,255
220: 178,228,253,255
221: 185,231,254,255
222: 189,233,254,255
223: 199,181,179,255
224: 206,178,142,255
225: 217,209,186,255
226: 203,202,181,255
227: 210,233,139,255
228: 195,255,191,255
229: 226,233,132,255
230: 236,237,153,255
231: 230,209,131,255
232: 198,200,201,255
233: 218,219,221,255
234: 209,204,207,255
235: 193,249,210,255
236: 198,226,238,255
237: 195,236,254,255
238: 201,239,254,255
239: 192,236,243,255
240: 205,246,232,255
241: 204,240,254,255
242: 210,242,255,255
243: 219,244,254,255
244: 211,244,244,255
245: 215,232,238,255
246: 230,234,237,255
247: 227,246,254,255
248: 233,247,253,255
249: 239,248,253,255
250: 234,248,254,255
251: 255,255,255,255
252: 251,254,255,255
253: 244,248,249,255
254: 244,240,238,255
255: 222,218,219,255", 
               "\n"))


ctab <- read.table(text = sapply(strsplit(tx, " "), "[", 2), sep = ",", col.names = c("R", "G", "B", "A"))
ct <- rgb(ctab$R, ctab$G, ctab$B, ctab$A, maxColorValue = 255)


## 0600 UTC 
##"http://www.bom.gov.au/charts_data/IDY20300/current/windarrow/10m/IDY20300.windarrow-10m.000.png?1449640800
product <- "current"
type <- "windarrow"
hour <- "000"
day <- format(unclass(as.POSIXct("2015-12-09 06:00:00", tz = "UTC")))
burlt <- sprintf("http://www.bom.gov.au/charts_data/IDY20300/%s/%s/10m/IDY20300.%s-10m.%s.png?%s", 
                 product, type, type, hour, day)
burlt

localname <- function(x) {
  root <- file.path(getOption("default.datadir"), "dev")
  root <- file.path("dev")
  ## strip the http:://
  file.path(root, sapply(strsplit(gsub("^http://", "", x), "\\?"), "[", 1))
}

remotename <- function(date, region = c("IDY20300", "IDY20001"),  product = c("current"), type = c("windarrow")) {
  ## 0600
  region <- match.arg(region)
  product <- match.arg(product)
  type <- match.arg(type)
  day <- format(unclass(as.POSIXct(paste(format(as.Date(date)), "06:00:00"), tz = "UTC")))
  h0 <- sprintf("%03d", seq(0, 69, by = 3))
  sprintf("http://www.bom.gov.au/charts_data/IDY20300/%s/%s/10m/IDY20300.%s-10m.%s.png?%s", 
                   product, type, type, h0, day)
  
}

download_png <- function(remote, local) {
  if (!file.exists(local)) {
    if (!file.exists(dirname(local))) dir.create(dirname(local), recursive = TRUE)
    res <- try(download.file(remote, local, mode = "wb"))
  }
  if (inherits(res, "try-error")) local <- sprintf("could not download %s to %s", remote, local)
  local
}
do_download <- function(date) {
  rnames <- remotename(date)
  lnames <- localname(rnames)
  report <- character(length(rnames))
  for (i in seq_along(rnames)) report[i] <- download_png(rnames[i], lnames[i])
  report
}


b <- raster(tfiles[1]); b <- setValues(brick(b, b, b), as.matrix(ctab[values(b) + 1, 1:3]))
plotRGB(b)
